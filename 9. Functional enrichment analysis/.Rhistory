result = df
if(numComponents==1){
df = df %>% select(Component_1) %>% as.matrix()
}
else{
df = df %>% select(Component_1, Component_2) %>% as.matrix()
}
result$group = kmeans(df, numClusters, nstart=50)$cluster
result = result %>% left_join(HOMD_mapping)
return(result)
}
clusterSubjectLoadings_filtered = function(model, filteredSubjects, numClusters){
numComponents = ncol(model[[3]]) - 1
df = model[[1]] %>% left_join(filteredSubjects) %>% filter(keep == 1)
result = df
if(numComponents==1){
df = df %>% select(Component_1) %>% as.matrix()
}
else{
df = df %>% select(Component_1, Component_2) %>% as.matrix()
}
result$group = kmeans(df, numClusters, nstart=50)$cluster
return(result)
}
featureLoadingLoadingPlot_varExp = function(model, title){
numComponents = ncol(model[[3]]) - 1
varExps = apply(model[[6]]^2, 2, function(x){sum(x, na.rm=TRUE)}) / apply(model[[7]]^2, 2, function(x){sum(x, na.rm=TRUE)}) * 100
df = model[[2]] %>% mutate(varExp = varExps)
if(numComponents == 1){
plot = model[[2]] %>% ggplot(aes(x=Component_1,y=0,col=varExps)) + geom_point() + scale_color_gradient2(low="blue", mid="purple", high="red", midpoint=50, breaks=seq(0,100,100), limits=c(0,100)) + ggtitle(title)
}
else{
plot = model[[2]] %>% ggplot(aes(x=Component_1,y=Component_2,col=varExps)) + geom_point() + scale_color_gradient2(low="blue", mid="purple", high="red", midpoint=50, breaks=seq(0,100,100), limits=c(0,100)) + ggtitle(title)
}
return(plot)
}
featureLoadingLoadingPlot_filtered = function(model, filteredFeatures, title){
numComponents = ncol(model[[3]]) - 1
df = model[[2]] %>% left_join(filteredFeatures, by = c("asv" = "featureName"))
if(numComponents == 1){
plot = df %>% ggplot(aes(x=Component_1,y=0,col=as.factor(keep))) + geom_point() + ggtitle(title)
}
else{
plot = df %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(keep))) + geom_point() + ggtitle(title)
}
return(plot)
}
subjectLoadingLoadingPlot_varExp = function(model, title){
numComponents = ncol(model[[3]]) - 1
varExps = apply(model[[4]]^2, 1, function(x){sum(x, na.rm=TRUE)}) / apply(model[[5]]^2, 1, function(x){sum(x, na.rm=TRUE)}) * 100
df = model[[1]] %>% mutate(varExp = varExps)
if(numComponents == 1){
plot = model[[1]] %>% ggplot(aes(x=Component_1,y=0,col=varExps)) + geom_point() + scale_color_gradient2(low="blue", mid="purple", high="red", midpoint=50, breaks=seq(0,100,100), limits=c(0,100)) + ggtitle(title)
}
else{
plot = model[[1]] %>% ggplot(aes(x=Component_1,y=Component_2,col=varExps)) + geom_point() + scale_color_gradient2(low="blue", mid="purple", high="red", midpoint=50, breaks=seq(0,100,100), limits=c(0,100)) + ggtitle(title)
}
return(plot)
}
subjectLoadingLoadingPlot_filtered = function(model, filteredSubjects, title){
numComponents = ncol(model[[3]]) - 1
df = model[[1]] %>% left_join(filteredSubjects)
if(numComponents == 1){
plot = df %>% ggplot(aes(x=Component_1,y=0,col=as.factor(keep))) + geom_point() + ggtitle(title)
}
else{
plot = df %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(keep))) + geom_point() + ggtitle(title)
}
return(plot)
}
featureLoadingLoadingPlot = function(model, title){
numComponents = ncol(model[[3]]) - 1
if(numComponents == 1){
plot = model[[2]] %>% ggplot(aes(x=Component_1,y=0)) + geom_point() + ggtitle(title)
}
else{
plot = model[[2]] %>% ggplot(aes(x=Component_1,y=Component_2)) + geom_point() + ggtitle(title)
}
return(plot)
}
subjectLoadingLoadingPlot = function(model, title){
numComponents = ncol(model[[3]]) - 1
if(numComponents == 1){
plot = model[[1]] %>% ggplot(aes(x=Component_1,y=0)) + geom_point() + ggtitle(title)
}
else{
plot = model[[1]] %>% ggplot(aes(x=Component_1,y=Component_2)) + geom_point() + ggtitle(title)
}
return(plot)
}
timeLoadingLoadingPlot = function(model, title){
numComponents = ncol(model[[3]]) - 1
modelVarExp = sum(model[[6]]^2) / sum(model[[7]]^2)
if(numComponents == 1){
plot = model[[3]] %>% ggplot(aes(x=Component_1,y=0,label=days)) + geom_path() + geom_text() + ggtitle(title)
}
else{
plot = model[[3]] %>% ggplot(aes(x=Component_1,y=Component_2,label=days)) + geom_path() + geom_text() + ggtitle(title)
}
return(plot)
}
congruencePlot_subjects = function(congruenceOutput, model, title){
numComponents = ncol(congruenceOutput)
modelledData = model[[4]]
inputData = model[[5]]
modelVarExp = sum(modelledData^2, na.rm=TRUE) / sum(inputData^2, na.rm=TRUE)
subjectVarExp = apply(modelledData^2, 1, function(x){sum(x, na.rm=TRUE)}) / apply(inputData^2, 1, function(x){sum(x, na.rm=TRUE)})
square_small = matrix(c(-0.5, -0.5, 0.5, 0.5, -0.5, -0.5, 0.5, 0.5, -0.5, -0.5), nrow=5, ncol=2) %>% as_tibble()
colnames(square_small) = c("x", "y")
square_large = matrix(c(-1,-1,1,1,-1,-1,1,1,-1,-1), nrow=5, ncol=2) %>% as_tibble()
colnames(square_large) = c("x", "y")
data = congruenceOutput %>% as_tibble() %>% mutate(normVarExp = (subjectVarExp / modelVarExp) - 1)
if(numComponents == 2){
plot = ggplot() + geom_point(data=data, aes(x=Congruence_1,y=Congruence_2,col=normVarExp)) + xlim(-1,1) + ylim(-1,1) + geom_path(aes(x=x,y=y), data=square_small) + geom_path(aes(x=x,y=y), data=square_large) + ggtitle(title)
}
else{
plot = ggplot() + geom_point(data=data, aes(x=Congruence_1,y=0,col=normVarExp)) + xlim(-1,1) + ylim(-1,1) + geom_vline(xintercept=0.5) + geom_vline(xintercept=-0.5) + geom_vline(xintercept=1) + geom_vline(xintercept=-1) + ggtitle(title)
}
return(plot)
}
congruencePlot_features = function(congruenceOutput, model, title){
numComponents = ncol(congruenceOutput)
modelledData = model[[6]]
inputData = model[[7]]
modelVarExp = sum(modelledData^2, na.rm=TRUE) / sum(inputData^2, na.rm=TRUE)
featureVarExp = apply(modelledData^2, 2, function(x){sum(x, na.rm=TRUE)}) / apply(inputData^2, 2, function(x){sum(x, na.rm=TRUE)})
square_small = matrix(c(-0.5, -0.5, 0.5, 0.5, -0.5, -0.5, 0.5, 0.5, -0.5, -0.5), nrow=5, ncol=2) %>% as_tibble()
colnames(square_small) = c("x", "y")
square_large = matrix(c(-1,-1,1,1,-1,-1,1,1,-1,-1), nrow=5, ncol=2) %>% as_tibble()
colnames(square_large) = c("x", "y")
data = congruenceOutput %>% as_tibble() %>% mutate(normVarExp = (featureVarExp / modelVarExp) - 1)
if(numComponents == 2){
plot = ggplot() + geom_point(data=data, aes(x=Congruence_1,y=Congruence_2,col=normVarExp)) + xlim(-1,1) + ylim(-1,1) + geom_path(aes(x=x,y=y), data=square_small) + geom_path(aes(x=x,y=y), data=square_large) + ggtitle(title)
}
else{
plot = ggplot() + geom_point(data=data, aes(x=Congruence_1,y=0,col=normVarExp)) + xlim(-1,1) + ylim(-1,1) + geom_vline(xintercept=0.5) + geom_vline(xintercept=-0.5) + geom_vline(xintercept=1) + geom_vline(xintercept=-1) + ggtitle(title)
}
return(plot)
}
plotSubjectClustering = function(model, subjectClustering, title){
numComponents = ncol(model[[3]]) - 1
if(numComponents==1){
plot = subjectClustering %>% ggplot(aes(x=Component_1,y=0,col=as.factor(group))) + geom_point() + geom_vline(xintercept=0, linetype=2) + ggtitle(title)
}
else{
plot = subjectClustering %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(group))) + geom_point() + geom_vline(xintercept=0, linetype=2) + geom_hline(yintercept=0, linetype=2) + ggtitle(title)
}
return(plot)
}
plotSubjectClustering_meta = function(model, subjectClustering, title){
numComponents = ncol(model[[3]]) - 1
if(numComponents==1){
plot = subjectClustering %>% ggplot(aes(x=Component_1,y=0,col=as.factor(RFgroup))) + geom_point() + geom_vline(xintercept=0, linetype=2) + ggtitle(title)
}
else{
plot = subjectClustering %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(RFgroup))) + geom_point() + geom_vline(xintercept=0, linetype=2) + geom_hline(yintercept=0, linetype=2) + ggtitle(title)
}
return(plot)
}
plotResponsePerSubjectGroup = function(model, featureClusteringResult, subjectClusteringResult, subjectGroup){
numFeatureGroups = max(featureClusteringResult$group)
df = model[[7]] %>% mutate(timepoint = rep(model[[3]]$days, nrow(model[[1]])), subject = rep(model[[1]]$subject, each=nrow(model[[3]]))) %>% pivot_longer(-c(timepoint,subject))
plotSubjects = subjectClusteringResult %>% filter(group == subjectGroup) %>% select(subject) %>% pull
plot = df %>% left_join(featureClusteringResult, by=c("name" = "asv")) %>% filter(subject %in% plotSubjects, group %in% 1:numFeatureGroups) %>% ggplot(aes(x=as.factor(timepoint),y=value,fill=as.factor(group))) + geom_boxplot() + geom_hline(yintercept=0, linetype=3) + ggtitle(paste0("Subject group ", subjectGroup))
return(plot)
}
plotResponsePerFeatureGroup = function(model, featureClusteringResult, subjectClusteringResult, featureGroup){
numSubjectGroups = max(subjectClusteringResult$group)
df = model[[7]] %>% mutate(timepoint = rep(model[[3]]$days, nrow(model[[1]])), subject = rep(model[[1]]$subject, each=nrow(model[[3]]))) %>% pivot_longer(-c(timepoint,subject))
plotFeatures = featureClusteringResult %>% filter(group == featureGroup) %>% select(asv) %>% pull
plot = df %>% left_join(subjectClusteringResult) %>% filter(name %in% plotFeatures, group %in% 1:numSubjectGroups) %>% ggplot(aes(x=as.factor(timepoint),y=value,fill=as.factor(group))) + geom_boxplot() + geom_hline(yintercept=0, linetype=3) + ggtitle(paste0("Feature group ", featureGroup))
return(plot)
}
metaPlot = function(model, featureClustering, subjectClustering){
plotList = list()
numFeatureGroups = max(featureClustering$group)
numSubjectGroups = max(subjectClustering$group)
numComponents = ncol(model[[3]]) - 1
plotIndex = 1
for(i in 1:numSubjectGroups){
plotList[[plotIndex]] = plotResponsePerSubjectGroup(model, featureClustering, subjectClustering, i)
plotIndex = plotIndex + 1
}
for(j in 1:numFeatureGroups){
plotList[[plotIndex]] = plotResponsePerFeatureGroup(model, featureClustering, subjectClustering, j)
plotIndex = plotIndex + 1
}
plotList[[plotIndex]] = plotFeatureClustering(model, featureClustering, "Feature loadings")
plotIndex = plotIndex + 1
plotList[[plotIndex]] = plotFeatureClustering_meta(model, featureClustering, "Feature loadings")
plotIndex = plotIndex + 1
plotList[[plotIndex]] = plotSubjectClustering(model, subjectClustering, "Subject loadings")
plotIndex = plotIndex + 1
plotList[[plotIndex]] = plotSubjectClustering_meta(model, subjectClustering, "Subject loadings")
ggarrange(plotlist=plotList)
}
plotFeatureClustering = function(model, featureClustering, title){
numComponents = ncol(model[[3]]) - 1
if(numComponents==1){
plot = featureClustering %>% ggplot(aes(x=Component_1,y=0,col=as.factor(group))) + geom_point() + geom_vline(xintercept=0, linetype=2) + ggtitle(title)
}
else{
plot = featureClustering %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(group))) + geom_point() + geom_vline(xintercept=0, linetype=2) + geom_hline(yintercept=0, linetype=2) + ggtitle(title)
}
return(plot)
}
plotFeatureClustering_meta = function(model, featureClustering, title){
numComponents = ncol(model[[3]]) - 1
if(numComponents==1){
plot = featureClustering %>% ggplot(aes(x=Component_1,y=0,col=as.factor(Phylum))) + geom_point() + geom_vline(xintercept=0, linetype=2) + ggtitle(title)
}
else{
plot = featureClustering %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(Phylum))) + geom_point() + geom_vline(xintercept=0, linetype=2) + geom_hline(yintercept=0, linetype=2) + ggtitle(title)
}
return(plot)
}
checkRawData = function(df, model, subjectClustering, featureClustering){
numSubjectGroups = max(subjectClustering$group)
numFeatureGroups = max(featureClustering$group)
plotlist = list()
plotIndex = 1
for(i in 1:numSubjectGroups){
subjectGroup = subjectClustering %>% filter(group == i) %>% select(subject) %>% pull
plotlist[[plotIndex]] = df %>% pivot_longer(-c(subject,timepoint)) %>% left_join(featureClustering, by=c("name"="asv")) %>% filter(subject %in% subjectGroup, group %in% 1:numFeatureGroups) %>% ggplot(aes(x=as.factor(timepoint), y=value, fill=as.factor(group))) + geom_boxplot() + ggtitle(paste0("Subject group ", i))
plotIndex = plotIndex + 1
}
for(j in 1:numFeatureGroups){
featureGroup = featureClustering %>% filter(group == j) %>% select(asv) %>% pull
plotlist[[plotIndex]] = df %>% pivot_longer(-c(subject,timepoint)) %>% left_join(subjectClustering) %>% filter(name %in% featureGroup, group %in% 1:numSubjectGroups) %>% ggplot(aes(x=as.factor(timepoint), y=value, fill=as.factor(group))) + geom_boxplot() + ggtitle(paste0("Feature group ", j))
plotIndex = plotIndex + 1
}
plotlist[[plotIndex]] = plotFeatureClustering(model, featureClustering, "Feature loadings")
plotIndex = plotIndex + 1
plotlist[[plotIndex]] = plotFeatureClustering_meta(model, featureClustering, "Feature loadings")
plotIndex = plotIndex + 1
plotlist[[plotIndex]] = plotSubjectClustering(model, subjectClustering, "Subject loadings")
plotIndex = plotIndex + 1
plotlist[[plotIndex]] = plotSubjectClustering_meta(model, subjectClustering, "Subject loadings")
ggarrange(plotlist=plotlist)
}
tongueSubjectVarExps = varexp_subjects(tongueModel)
lowlingSubjectVarExps = varexp_subjects(lowlingModel)
lowinterSubjectVarExps = varexp_subjects(lowinterModel)
uplingSubjectVarExps = varexp_subjects(uplingModel)
upinterSubjectVarExps = varexp_subjects(upinterModel)
salivaSubjectVarExps = varexp_subjects(salivaModel)
metabolomicsSubjectVarExps = varexp_subjects(metabolomicsModel)
tongueFeatureVarExps = varexp_features(tongueModel, "asv")
lowlingFeatureVarExps = varexp_features(lowlingModel, "asv")
lowinterFeatureVarExps = varexp_features(lowinterModel, "asv")
uplingFeatureVarExps = varexp_features(uplingModel, "asv")
upinterFeatureVarExps = varexp_features(upinterModel, "asv")
salivaFeatureVarExps = varexp_features(salivaModel, "asv")
metabolomicsFeatureVarExps = varexp_features(metabolomicsModel, "BIOCHEMICAL")
loadCongruences = function(path, nameVector){
df = read.csv(path, header=FALSE)
numComponents = ncol(df)
colnames(df) = paste0("Congruence_", 1:numComponents)
row.names(df) = nameVector
return(df)
}
tongueSubjectCongruences = loadCongruences("./20230605_run/Tongue_individual_congruence_loadings.csv", tongueModel[[1]]$subject)
lowlingSubjectCongruences = loadCongruences("./20230605_run/Low_ling_individual_congruence_loadings.csv", lowlingModel[[1]]$subject)
lowinterSubjectCongruences = loadCongruences("./20230605_run/Low_inter_individual_congruence_loadings.csv", lowinterModel[[1]]$subject)
uplingSubjectCongruences = loadCongruences("./20230605_run/Up_ling_individual_congruence_loadings.csv", uplingModel[[1]]$subject)
upinterSubjectCongruences = loadCongruences("./20230605_run/Up_inter_individual_congruence_loadings.csv", upinterModel[[1]]$subject)
salivaSubjectCongruences = loadCongruences("./20230605_run/Saliva_individual_congruence_loadings.csv", salivaModel[[1]]$subject)
metabolomicsSubjectCongruences = loadCongruences("./20230605_run/Metabolomics_individual_congruence_loadings.csv", metabolomicsModel[[1]]$subject)
tongueFeatureCongruences = loadCongruences("./20230605_run/Tongue_feature_congruence_loadings.csv", tongueModel[[2]]$asv)
lowlingFeatureCongruences = loadCongruences("./20230605_run/Low_ling_feature_congruence_loadings.csv", lowlingModel[[2]]$asv)
lowinterFeatureCongruences = loadCongruences("./20230605_run/Low_inter_feature_congruence_loadings.csv", lowinterModel[[2]]$asv)
uplingFeatureCongruences = loadCongruences("./20230605_run/Up_ling_feature_congruence_loadings.csv", uplingModel[[2]]$asv)
upinterFeatureCongruences = loadCongruences("./20230605_run/Up_inter_feature_congruence_loadings.csv", upinterModel[[2]]$asv)
salivaFeatureCongruences = loadCongruences("./20230605_run/Saliva_feature_congruence_loadings.csv", salivaModel[[2]]$asv)
metabolomicsFeatureCongruences = loadCongruences("./20230605_run/Metabolomics_feature_congruence_loadings.csv", metabolomicsModel[[2]]$BIOCHEMICAL)
a = featureLoadingLoadingPlot_varExp(tongueModel, "tongue")
b = featureLoadingLoadingPlot_varExp(lowlingModel, "lowling")
c = featureLoadingLoadingPlot_varExp(lowinterModel, "lowinter")
d = featureLoadingLoadingPlot_varExp(uplingModel, "upling")
e = featureLoadingLoadingPlot_varExp(upinterModel, "upinter")
f = featureLoadingLoadingPlot_varExp(salivaModel, "saliva")
ggarrange(a,b,c,d,e,f,common.legend=TRUE)
featureLoadingLoadingPlot_varExp(metabolomicsModel, "metabolomics")
a = congruencePlot_features(tongueFeatureCongruences, tongueModel, "tongue")
b = congruencePlot_features(lowlingFeatureCongruences, lowlingModel, "lowling")
c = congruencePlot_features(lowinterFeatureCongruences, lowinterModel, "lowinter")
d = congruencePlot_features(uplingFeatureCongruences, uplingModel, "upling")
e = congruencePlot_features(upinterFeatureCongruences, upinterModel, "upinter")
f = congruencePlot_features(salivaFeatureCongruences, salivaModel, "saliva")
ggarrange(a,b,c,d,e,f)
congruencePlot_features(metabolomicsFeatureCongruences, metabolomicsModel, "metabolomics")
microbiomeFilter = 1 # this is one times the varExp of the entire model
metabolomeFilter = 2 # this is two times the varExp of the entire model
tongueFilteredFeatures_varexp = filterFeatures(tongueModel, microbiomeFilter)
lowlingFilteredFeatures_varexp = filterFeatures(lowlingModel, microbiomeFilter)
lowinterFilteredFeatures_varexp = filterFeatures(lowinterModel, microbiomeFilter)
uplingFilteredFeatures_varexp = filterFeatures(uplingModel, microbiomeFilter)
upinterFilteredFeatures_varexp = filterFeatures(upinterModel, microbiomeFilter)
salivaFilteredFeatures_varexp = filterFeatures(salivaModel, microbiomeFilter)
metabolomicsFilteredFeatures_varexp = filterFeatures(metabolomicsModel, metabolomeFilter)
# Plot the result
a = featureLoadingLoadingPlot_filtered(tongueModel, tongueFilteredFeatures_varexp, "tongue")
b = featureLoadingLoadingPlot_filtered(lowlingModel, lowlingFilteredFeatures_varexp, "lowling")
c = featureLoadingLoadingPlot_filtered(lowinterModel, lowinterFilteredFeatures_varexp, "lowinter")
d = featureLoadingLoadingPlot_filtered(uplingModel, uplingFilteredFeatures_varexp, "upling")
e = featureLoadingLoadingPlot_filtered(upinterModel, upinterFilteredFeatures_varexp, "upinter")
f = featureLoadingLoadingPlot_filtered(salivaModel, salivaFilteredFeatures_varexp, "saliva")
ggarrange(a,b,c,d,e,f, common.legend=TRUE)
model = metabolomicsModel
filteredFeatures = metabolomicsFilteredFeatures_varexp
title = "metabolomics"
numComponents = ncol(model[[3]]) - 1
df = model[[2]] %>% left_join(filteredFeatures, by = c("BIOCHEMICAL" = "featureName"))
df %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(keep))) + geom_point() + ggtitle(title)
microbiomeFilter = 0.4 # this is having a congruence of 0.4 in either component
metabolomeFilter = 0.4 # this is having a congruence of 0.4 in either component
tongueFilteredFeatures_congruence = filterByCongruence(tongueFeatureCongruences, tongueModel[[2]]$asv, "featureName", microbiomeFilter)
lowlingFilteredFeatures_congruence = filterByCongruence(lowlingFeatureCongruences, lowlingModel[[2]]$asv, "featureName", microbiomeFilter)
lowinterFilteredFeatures_congruence = filterByCongruence(lowinterFeatureCongruences, lowinterModel[[2]]$asv, "featureName", microbiomeFilter)
uplingFilteredFeatures_congruence = filterByCongruence(uplingFeatureCongruences, uplingModel[[2]]$asv, "featureName", microbiomeFilter)
upinterFilteredFeatures_congruence = filterByCongruence(upinterFeatureCongruences, upinterModel[[2]]$asv, "featureName", microbiomeFilter)
salivaFilteredFeatures_congruence = filterByCongruence(salivaFeatureCongruences, salivaModel[[2]]$asv, "featureName", microbiomeFilter)
metabolomicsFilteredFeatures_congruence = filterByCongruence(metabolomicsFeatureCongruences, metabolomicsModel[[2]]$BIOCHEMICAL, "featureName", metabolomeFilter)
# Plot the result
a = featureLoadingLoadingPlot_filtered(tongueModel, tongueFilteredFeatures_congruence, "tongue")
b = featureLoadingLoadingPlot_filtered(lowlingModel, lowlingFilteredFeatures_congruence, "lowling")
c = featureLoadingLoadingPlot_filtered(lowinterModel, lowinterFilteredFeatures_congruence, "lowinter")
d = featureLoadingLoadingPlot_filtered(uplingModel, uplingFilteredFeatures_congruence, "upling")
e = featureLoadingLoadingPlot_filtered(upinterModel, upinterFilteredFeatures_congruence, "upinter")
f = featureLoadingLoadingPlot_filtered(salivaModel, salivaFilteredFeatures_congruence, "saliva")
ggarrange(a,b,c,d,e,f, common.legend=TRUE)
model = metabolomicsModel
filteredFeatures = metabolomicsFilteredFeatures_congruence
title = "metabolomics"
numComponents = ncol(model[[3]]) - 1
df = model[[2]] %>% left_join(filteredFeatures, by = c("BIOCHEMICAL" = "featureName"))
df %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(keep))) + geom_point() + ggtitle(title)
tongueFilteredFeatures = tongueFilteredFeatures_varexp %>% mutate(keep = (tongueFilteredFeatures_varexp$keep==TRUE & tongueFilteredFeatures_congruence$keep==TRUE))
lowlingFilteredFeatures = lowlingFilteredFeatures_varexp %>% mutate(keep = (lowlingFilteredFeatures_varexp$keep==TRUE & lowlingFilteredFeatures_congruence$keep==TRUE))
lowinterFilteredFeatures = lowinterFilteredFeatures_varexp %>% mutate(keep = (lowinterFilteredFeatures_varexp$keep==TRUE & lowinterFilteredFeatures_congruence$keep==TRUE))
uplingFilteredFeatures = uplingFilteredFeatures_varexp %>% mutate(keep = (uplingFilteredFeatures_varexp$keep==TRUE & uplingFilteredFeatures_congruence$keep==TRUE))
upinterFilteredFeatures = upinterFilteredFeatures_varexp %>% mutate(keep = (upinterFilteredFeatures_varexp$keep==TRUE & upinterFilteredFeatures_congruence$keep==TRUE))
salivaFilteredFeatures = salivaFilteredFeatures_varexp %>% mutate(keep = (salivaFilteredFeatures_varexp$keep==TRUE & salivaFilteredFeatures_congruence$keep==TRUE))
metabolomicsFilteredFeatures = metabolomicsFilteredFeatures_varexp %>% mutate(keep = (metabolomicsFilteredFeatures_varexp$keep==TRUE & metabolomicsFilteredFeatures_congruence$keep==TRUE))
# Plot the result
a = featureLoadingLoadingPlot_filtered(tongueModel, tongueFilteredFeatures, "tongue")
b = featureLoadingLoadingPlot_filtered(lowlingModel, lowlingFilteredFeatures, "lowling")
c = featureLoadingLoadingPlot_filtered(lowinterModel, lowinterFilteredFeatures, "lowinter")
d = featureLoadingLoadingPlot_filtered(uplingModel, uplingFilteredFeatures, "upling")
e = featureLoadingLoadingPlot_filtered(upinterModel, upinterFilteredFeatures, "upinter")
f = featureLoadingLoadingPlot_filtered(salivaModel, salivaFilteredFeatures, "saliva")
ggarrange(a,b,c,d,e,f, common.legend=TRUE)
model = metabolomicsModel
filteredFeatures = metabolomicsFilteredFeatures
title = "metabolomics"
numComponents = ncol(model[[3]]) - 1
df = model[[2]] %>% left_join(filteredFeatures, by = c("BIOCHEMICAL" = "featureName"))
df %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(keep))) + geom_point() + ggtitle(title)
labelledFilteredFeaturesPlot = function(model, filteredFeatures, title){
numComponents = ncol(model[[3]]) - 1
df = model[[2]] %>% left_join(filteredFeatures, by=c("asv" = "featureName")) %>% filter(keep==TRUE) %>% left_join(HOMD_mapping)
if(numComponents == 1){
plot = df %>% ggplot(aes(x=Component_1, y=0, col=as.factor(Phylum), label=homd)) + geom_point() + geom_text_repel(col="black") + ggtitle(title)
}
else{
plot = df %>% ggplot(aes(x=Component_1, y=Component_2, col=as.factor(Phylum), label=homd)) + geom_point() + geom_text_repel(col="black", max.overlaps=50) + ggtitle(title)
}
return(plot)
}
labelledFilteredFeaturesPlot(tongueModel, tongueFilteredFeatures, "tongue")
labelledFilteredFeaturesPlot(lowlingModel, lowlingFilteredFeatures, "lowling")
labelledFilteredFeaturesPlot(lowinterModel, lowinterFilteredFeatures, "lowinter")
labelledFilteredFeaturesPlot(uplingModel, uplingFilteredFeatures, "upling")
labelledFilteredFeaturesPlot(upinterModel, upinterFilteredFeatures, "upinter")
labelledFilteredFeaturesPlot(salivaModel, salivaFilteredFeatures, "saliva")
model = metabolomicsModel
filteredFeatures = metabolomicsFilteredFeatures
df = model[[2]] %>% left_join(filteredFeatures, by=c("BIOCHEMICAL" = "featureName")) %>% filter(keep==TRUE)
plot = df %>% ggplot(aes(x=Component_1, y=Component_2, col=as.factor(SUPER_PATHWAY), label=BIOCHEMICAL)) + geom_point() + geom_text_repel(col="black") + ggtitle("Metabolomics")
print(plot)
make_elbow_plot = function(model, filteredFeatures, plotTitle, k.max=10){
set.seed(123)
numComponents = ncol(model[[3]]) - 1
if(numComponents == 1){
df = model[[2]] %>% filter(asv %in% (filteredFeatures %>% filter(keep==TRUE) %>% select(featureName) %>% pull())) %>% select(Component_1)
}
else{
df = model[[2]] %>% filter(asv %in% (filteredFeatures %>% filter(keep==TRUE) %>% select(featureName) %>% pull())) %>% select(Component_1, Component_2)
}
wss = sapply(1:k.max,
function(k){kmeans(df, k, nstart=50,iter.max = 15 )$tot.withinss})
plottableData = cbind(1:k.max, wss) %>% as_tibble()
colnames(plottableData) = c("numClusters", "WSS")
plottableData %>% ggplot(aes(x=numClusters,y=WSS)) +
geom_point() +
geom_line() +
xlab("Number of clusters K") +
ylab("Total within-clusters sum of squares") +
ggtitle(plotTitle)
}
a = make_elbow_plot(tongueModel, tongueFilteredFeatures, "Tongue", 10)
b = make_elbow_plot(lowlingModel, lowlingFilteredFeatures, "Lowling", 10)
c = make_elbow_plot(lowinterModel, lowinterFilteredFeatures, "Lowinter", 3)
d = make_elbow_plot(uplingModel, uplingFilteredFeatures, "Upling", 10)
e = make_elbow_plot(upinterModel, upinterFilteredFeatures, "Upinter", 10)
f = make_elbow_plot(salivaModel, salivaFilteredFeatures, "Saliva", 10)
ggarrange(a,b,c,d,e,f)
tongueFeatureClustering = clusterFeatureLoadings_filtered(tongueModel, tongueFilteredFeatures, 2)
a = plotFeatureClustering(tongueModel, tongueFeatureClustering, "tongue")
b = plotFeatureClustering_meta(tongueModel, tongueFeatureClustering, "tongue")
ggarrange(a,b)
lowlingFeatureClustering = clusterFeatureLoadings_filtered(lowlingModel, lowlingFilteredFeatures, 2)
a = plotFeatureClustering(lowlingModel, lowlingFeatureClustering, "lowling")
b = plotFeatureClustering_meta(lowlingModel, lowlingFeatureClustering, "lowling")
ggarrange(a,b)
lowinterFeatureClustering = clusterFeatureLoadings_filtered(lowinterModel, lowinterFilteredFeatures, 2)
a = plotFeatureClustering(lowinterModel, lowinterFeatureClustering, "lowinter")
b = plotFeatureClustering_meta(lowinterModel, lowinterFeatureClustering, "lowinter")
ggarrange(a,b)
uplingFeatureClustering = clusterFeatureLoadings_filtered(uplingModel, uplingFilteredFeatures, 2)
a = plotFeatureClustering(uplingModel, uplingFeatureClustering, "upling")
b = plotFeatureClustering_meta(uplingModel, uplingFeatureClustering, "upling")
ggarrange(a,b)
upinterFeatureClustering = clusterFeatureLoadings_filtered(upinterModel, upinterFilteredFeatures, 3)
a = plotFeatureClustering(upinterModel, upinterFeatureClustering, "upinter")
b = plotFeatureClustering_meta(upinterModel, upinterFeatureClustering, "upinter")
ggarrange(a,b)
salivaFeatureClustering = clusterFeatureLoadings_filtered(salivaModel, salivaFilteredFeatures, 3)
a = plotFeatureClustering(salivaModel, salivaFeatureClustering, "saliva")
b = plotFeatureClustering_meta(salivaModel, salivaFeatureClustering, "saliva")
ggarrange(a,b)
model = metabolomicsModel
numClusters = 2
filteredFeatures = metabolomicsFilteredFeatures
df = model[[2]] %>% left_join(filteredFeatures, by = c("BIOCHEMICAL" = "featureName")) %>% filter(keep == 1)
result = df
df = df %>% select(Component_1, Component_2) %>% as.matrix()
result$group = kmeans(df, numClusters, nstart=50)$cluster
metabolomicsFeatureClustering = result
a = plotFeatureClustering(metabolomicsModel, metabolomicsFeatureClustering, "metabolomics")
model = metabolomicsModel
featureClustering = metabolomicsFeatureClustering
title = "metabolomics"
numComponents = ncol(model[[3]]) - 1
b = featureClustering %>% ggplot(aes(x=Component_1,y=Component_2,col=as.factor(SUPER_PATHWAY))) + geom_point() + geom_vline(xintercept=0, linetype=2) + geom_hline(yintercept=0, linetype=2) + ggtitle(title)
ggarrange(a,b)
salivaFeatureClustering = clusterFeatureLoadings_filtered(salivaModel, salivaFilteredFeatures, 2)
a = plotFeatureClustering(tongueModel, tongueFeatureClustering, "tongue")
b = plotFeatureClustering(lowlingModel, lowlingFeatureClustering, "lowling")
c = plotFeatureClustering(lowinterModel, lowinterFeatureClustering, "lowinter")
d = plotFeatureClustering(uplingModel, uplingFeatureClustering, "upling")
e = plotFeatureClustering(upinterModel, upinterFeatureClustering, "upinter")
f = plotFeatureClustering(salivaModel, salivaFeatureClustering, "saliva")
ggarrange(a,b,c,d,e,f)
ggarrange(a,b,c,d,e,f)
testExclusivity = function(microbiome.raw, nicheName, featureClustering, minReads=0, presenceFrac=0.5){
numGroups = max(featureClustering$group)
numCombinations = 2**numGroups - numGroups - 1
df = microbiome.raw %>% as_tibble() %>% filter(group == "control", niche == nicheName) %>% select(-sample, -group, -niche)
df.numeric = df[,3:ncol(df)]
results = list()
for(i in 1:max(featureClustering$group)){
dummy =  df.numeric %>% select(featureClustering %>% filter(group == i) %>% select(asv) %>% pull())
dummy = dummy > minReads
dummy = rowSums(dummy) / ncol(dummy)
#dummy = apply(dummy, 1, mean)
results[[i]] = dummy
}
presenceAbsence = as.data.frame(do.call(cbind, results))
presenceAbsence = presenceAbsence > presenceFrac
allResults = list()
summaryPvalues = list()
testResults = list()
summaryIterator = 1
for(i in 1:(numGroups-1)){
for(j in (i+1):numGroups){
#print(i)
#print(j)
result = matrix(c(sum(presenceAbsence[,i] & presenceAbsence[,j]), sum(!presenceAbsence[,i] & presenceAbsence[,j]), sum(presenceAbsence[,i] & !presenceAbsence[,j]), sum(!presenceAbsence[,i] & !presenceAbsence[,j])), nrow=2, ncol=2)
#print(result)
testResult = fisher.test(result, alternative="less")
#print(testResult)
#print("-------------------------------------------")
allResults[[summaryIterator]] = result
testResults[[summaryIterator]] = testResult
summaryPvalues[summaryIterator] = testResult$p.value
summaryIterator = summaryIterator + 1
}
}
return(list(presenceAbsence,allResults, testResults, unlist(summaryPvalues)))
}
tongueExclusivity = testExclusivity(microbiome.raw, "tongue", tongueFeatureClustering)
lowlingExclusivity = testExclusivity(microbiome.raw, "lower jaw, lingual", lowlingFeatureClustering)
lowinterExclusivity = testExclusivity(microbiome.raw, "lower jaw, interproximal", lowinterFeatureClustering)
uplingExclusivity = testExclusivity(microbiome.raw, "upper jaw, lingual", uplingFeatureClustering)
upinterExclusivity = testExclusivity(microbiome.raw, "upper jaw, interproximal", upinterFeatureClustering)
salivaExclusivity = testExclusivity(microbiome.raw, "saliva", salivaFeatureClustering)
tongueExclusivity
lowlingExclusivity
lowinterExclusivity
uplingExclusivity
upinterExclusivity
upinterExclusivity[[1]]
upinterExclusivity[[2]]
salivaExclusivity[[2]]
tongueExclusivity[[4]]
lowlingExclusivity[[4]]
0.0001521408
lowinterExclusivity[[4]]
uplingExclusivity[[4]]
upinterExclusivity[[4]]
salivaExclusivity[[4]]
